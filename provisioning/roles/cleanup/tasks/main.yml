---
- include_vars: ../../common_vars.yml

- name: Remove some directories to open space for docker
  become: yes
  shell: |
    rm -rf /var/cache/*
    rm -rf /usr/share/man/*
    rm -rf /var/log/*
    rm -rf /usr/share/doc/*
    rm -rf /usr/share/locale/*

- name: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n
  become: yes
  shell: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n | tail -100
  register: dq

- debug: var=dq.stdout_lines

- name: df -h
  become: yes
  shell: df -h
  register: df2

- debug: var=df2.stdout_lines

- name: remove some unused packages to open space for docker
  become: yes
  shell: |
    apt-get remove --yes --fix-broken --quiet --purge \
      iso-codes \
      ieee-data \
      libllvm18 \
      python3-botocore \
      libclang-cpp18 \
      vim-runtime \
      git \
      python3-twisted \
      python-babel-localedata \
      python3-pygments \
      python3-cryptography \
      python3-setuptools \
      libicu74 \
      locales \
      intel-microcode \
      libpython3.12t64 \
      libmagic-mgc \
      python3-launchpadlib \
      python3-netaddr \
      python3-chardet \
      python3-rich \
      python3-boto3 \
      python3-zope.interface \
      python3-gi \
      python3-pyasn1-modules \
      python3-oauthlib \
      python3-jinja2 \
      python3-yaml \
      python3-jsonschema \
      python3-apport \
      python3-serial \
      python3-urllib3 \
      python3-babel

- name: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n | grep  'python3-*'
  become: yes
  shell: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n | grep  'python3-*'
  register: p3

- debug: var=p3.stdout_lines

- name: dpkg-query -W -f='${Package}\n' | sort -n | grep  'python3-*' | xargs apt-get remove -y
  become: yes
  shell: dpkg-query -W -f='${Package}\n' | sort -n | grep  'python3-*' | xargs apt-get remove -y
  register: pr
  ignore_errors: true

- debug: var=pr.stdout_lines

- name: see unused kernel packages
  become: yes
  shell: |
    dpkg -l 'linux-*' | \
    sed '/^ii/!d;/'"$(uname -r | sed 's/\(.*\)-\([^0-9]\+\)/\1/')"'/d;s/^[^ ]* [^ ]* \([^ ]*\).*/\1/;/[0-9]/!d'
  register: uk

- debug: var=uk.stdout_lines

- name: remove unused kernel packages
  become: yes
  shell: |
    dpkg -l 'linux-*' | \
    sed '/^ii/!d;/'"$(uname -r | sed 's/\(.*\)-\([^0-9]\+\)/\1/')"'/d;s/^[^ ]* [^ ]* \([^ ]*\).*/\1/;/[0-9]/!d' | \
    xargs -r sudo apt remove --purge -y

- name: journalctl --flush --rotate --vacuum-time=1s
  become: yes
  shell: journalctl --flush --rotate --vacuum-time=1s
  register: jc

- debug: var=jc.stdout_lines

- name: apt autoremove to open space for docker
  become: yes
  shell: apt autoremove -y

- name: df -h
  become: yes
  shell: df -h
  register: df

- debug: var=df.stdout_lines

- name: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n
  become: yes
  shell: dpkg-query -W -f='${Installed-Size;8}  ${Package}\n' | sort -n | tail -50
  register: dq2

- debug: var=dq2.stdout_lines
