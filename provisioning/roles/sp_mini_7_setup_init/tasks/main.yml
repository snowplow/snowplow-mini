---
- include_vars: ../../common_vars.yml

# Copy systemd service for snowplow_mini_control_plane_api
- name: Copy snowplow_mini_control_plane_api systemd unit
  become: yes
  copy:
    src: "{{ init_dir }}/snowplow_mini_control_plane_api.service"
    dest: /etc/systemd/system/snowplow_mini_control_plane_api.service
    mode: '0644'

# Copy systemd service for snowplow_mini (main service)
- name: Copy snowplow_mini systemd unit
  become: yes
  copy:
    src: "{{ init_dir }}/snowplow_mini.service"
    dest: /etc/systemd/system/snowplow_mini.service
    mode: '0644'

# Reload systemd and enable + start services
- name: Reload systemd and enable/start services
  become: yes
  systemd:
    daemon_reload: yes
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - snowplow_mini
    - snowplow_mini_control_plane_api

# Cronjob: Clean old docs from 'good' index
- name: Add cronjob to clean old ES 'good' index documents
  cron:
    name: "Crop ES 'good' index older than a week"
    special_time: weekly
    job: >
      /usr/bin/curl -s -X POST http://localhost:9200/good/_delete_by_query
      -H 'Content-Type:application/json'
      -d '{ "query" :{ "range" :{ "collector_tstamp" :{ "lt" :"now-1w/d" } } } }'
      >> /home/ubuntu/snowplow/good_cron.out 2>> /home/ubuntu/snowplow/good_cron.err

# Cronjob: Clean old docs from 'bad' index
- name: Add cronjob to clean old ES 'bad' index documents
  cron:
    name: "Crop ES 'bad' index older than a week"
    special_time: weekly
    job: >
      /usr/bin/curl -s -X POST http://localhost:9200/bad/_delete_by_query
      -H 'Content-Type:application/json'
      -d '{ "query" :{ "range" :{ "data.failure.timestamp" :{ "lt" :"now-1w/d" } } } }'
      >> /home/ubuntu/snowplow/bad_cron.out 2>> /home/ubuntu/snowplow/bad_cron.err

# Cronjob: Clean NSQ data
- name: Add cronjob to clean NSQ data
  cron:
    name: "Crop NSQ data"
    special_time: weekly
    job: /bin/rm -rf /home/ubuntu/snowplow/nsq-data/*

# Ensure policykit-1 is up to date
- name: Upgrade policykit-1 to latest
  become: yes
  apt:
    name: policykit-1
    state: latest
    update_cache: yes
